#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import sys
import os
from pydub import AudioSegment

def load_wav(path):
    return AudioSegment.from_wav(path)

def get_loudness(audio):
    return audio.dBFS

def match_volume(source_audio, target_dBFS):
    gain_needed = target_dBFS - source_audio.dBFS
    return source_audio.apply_gain(gain_needed)

###
### Main driver
###

def main():
    if len(sys.argv) < 4:
        print("Usage: NormalizeVolume input1.wav [input2.wav ...] output.wav")
        sys.exit(1)

    input_files = sys.argv[1:-1]
    output_file = sys.argv[-1]

    # Check file existence
    for f in input_files:
        if not os.path.exists(f):
            print(f"Input file missing: {f}")
            sys.exit(1)

    # Load all input audios
    audios = [load_wav(f) for f in input_files]
    loudnesses = [get_loudness(a) for a in audios]

    # Print loudness report
    for f, l in zip(input_files, loudnesses):
        print(f"{l:.2f} {f}")

    # Find the loudest (highest dBFS) track
    loudest_dBFS = max(loudnesses)

    # Normalize all to the loudest file
    normalized_audios = [match_volume(a, loudest_dBFS) for a in audios]

    # Concatenate all normalized files
    combined = AudioSegment.empty()
    for audio in normalized_audios:
        combined += audio

    # Export final result
    combined.export(output_file, format="wav")

    print(f"All input files normalized and merged into: {output_file}")
    print(f"Target loudness: {loudest_dBFS:.2f} dBFS")

if __name__ == "__main__":
    main()

